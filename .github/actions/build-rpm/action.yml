# .github/actions/build-rpm/action.yml
name: "Build COSMIC Package"
description: "Common build steps for COSMIC components"
inputs:
  app_name:
    required: true
  repository:
    required: true
  ref:
    required: true
  cargo_patch:
    required: false
    default: ""
  arch:
    description: "Target architecture (amd64 or arm64)"
    required: true
    default: "amd64"

runs:
  using: "composite"
  steps:
    - name: Check out app code
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}
        fetch-depth: 0

    - name: Check out repository
      uses: actions/checkout@v4
      with:
        path: "build"

    - name: Install System Dependencies
      shell: bash
      run: |
        # EPEL 10 の導入
        dnf install -y epel-release
        # EL10では CRB の有効化方法が標準化されています
        dnf config-manager --set-enabled crb || dnf install -y 'dnf-command(config-manager)' && dnf config-manager --set-enabled crb
        # just を含む全依存関係を RPM でインストール
        dnf install -y \
          rpm-build \
          pkgconfig \
          gcc-c++ \
          cargo \
          rust \
          just \
          glib2-devel \
          libxkbcommon-devel \
          cmake \
          freetype-devel \
          fontconfig-devel \
          wayland-devel \
          libinput-devel \
          libxkbcommon-x11-devel

    - name: Prepare Sources
      shell: bash
      run: |
        mkdir -p ~/rpmbuild/SOURCES
          
        # 1. cargo vendor を直接実行して vendor ディレクトリを強制作成
        # これにより全依存関係が ./vendor にダウンロードされます
        cargo vendor
          
        # 2. just build-vendored が期待する形式に固める
        # vendor ディレクトリが存在することを確認してから実行
        if [ -d "vendor" ]; then
          tar -cf vendor.tar vendor/
        else
          echo "Error: vendor directory was not created!"
          exit 1
        fi
          
        # 3. RPMビルド用のディレクトリ構造を作成して固める
        mkdir -p ../cosmic-edit-ime-0.1.0
        cp -r . ../cosmic-edit-ime-0.1.0/
        cd ..
        tar -czf ~/rpmbuild/SOURCES/cosmic-edit-ime-0.1.0.tar.gz cosmic-edit-ime-0.1.0/

    - name: Rust Cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: .
        # アーキテクチャごとにキャッシュを分ける
        key: ${{ inputs.app_name }}-${{ inputs.arch }}

    - name: Patch Cargo.toml
      if: ${{ inputs.cargo_patch != '' }}
      shell: bash
      run: |
        ${{ inputs.cargo_patch }}
        cp build/${{ inputs.app_name }}/Cargo.lock . || true

    - name: Execute rpmbuild
      shell: bash
      run: |
        rpmbuild -ba build/cosmic-edit/rpm/cosmic-edit.spec --define "_topdir $HOME/rpmbuild"

    - name: Prepare Artifacts
      shell: bash
      run: |
        mkdir -p dist
        # 拡張子が異なる場合を考慮してコピー
        mv ~/rpmbuild/RPMS/*/*.rpm dist/

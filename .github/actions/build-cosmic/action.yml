# .github/actions/build-cosmic/action.yml
name: 'Build COSMIC Package'
description: 'Common build steps for COSMIC components'
inputs:
  app_name:
    description: 'Name of the application (e.g., cosmic-files)'
    required: true
  repository:
    description: 'Repository to clone'
    required: true
  ref:
    description: 'Branch or tag'
    required: true
  cargo_patch:
    description: 'Shell commands to patch Cargo.toml (optional)'
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    - name: Check out app code
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}
        fetch-depth: 0

    - name: Check out repository
      uses: actions/checkout@v4
      with:
        path: 'build'

    - name: Install build tools
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y devscripts debhelper equivs

    - name: Overwrite and install package build dependencies
      shell: bash
      run: |
        cp build/debian/${{ inputs.app_name }}/{changelog,control,rules} debian/
        sudo mk-build-deps -i -t "apt-get -o Debug::pkgProblemResolver=yes -y" debian/control

    - name: Rust Cache
      uses: swatinem/rust-cache@v2

    - name: Pre-extract and Patch
      shell: bash
      run: |
        # debuildが走る前に、手動でvendorを展開してしまう
        just vendor-extract
        
        # 展開された後にパッチを適用（これでvendor内のソースではなく、現在のCargo.tomlの指示が優先される）
        if [ -n "${{ inputs.cargo_patch }}" ]; then
          ${{ inputs.cargo_patch }}
          # --offlineでも、すでにvendorにあるものとの整合性を取るためにupdateが必要
          cargo update libcosmic --offline || cargo update libcosmic
        fi

    - name: Build package using debuild
      shell: bash
      run: |
        # キャッシュ対象となるディレクトリを環境変数で固定
        export CARGO_TARGET_DIR=$(pwd)/target
        
        # -e で環境変数を debuild の内部に引き継ぐ
        # vendor-extractが二度走り、パッチが消えるのを防ぐために
        # debuild 経由ではなく直接的なビルドコマンドを検討したいが、
        # まずは環境変数の維持を試す
        debuild \
          -e PATH=$PATH \
          -e CARGO_TARGET_DIR=$CARGO_TARGET_DIR \
          -e CARGO_HOME=$HOME/.cargo \
          -us -uc -b -j$(nproc)

    - name: Check Cache Size (Debug)
      shell: bash
      run: du -sh target || echo "target not found"

    - name: Prepare Artifacts
      shell: bash
      run: |
        mkdir -p dist
        mv *.deb *.changes *.buildinfo dist/ 2>/dev/null || true

# .github/workflows/build.yml
name: Build and Publish Apt Repo
on: [push]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-all:
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        id: [files, edit, term]
        include:
          - id: files
            name: cosmic-files
            repo: pop-os/cosmic-files
            ref: epoch-1.0.0
            patch: |
              cat <<EOF >> Cargo.toml
              [patch.'https://github.com/pop-os/libcosmic']
              libcosmic = { git = "https://github.com/kenz-gelsoft/libcosmic.git", branch = "backport-input-method2" }
              EOF
          - id: edit
            name: cosmic-edit
            repo: kenz-gelsoft/cosmic-edit
            ref: backport-input-method
            patch: ""
          - id: term
            name: cosmic-term
            repo: kenz-gelsoft/cosmic-term
            ref: backport-input-method
            patch: ""

    name: Build ${{ matrix.name }} (${{ matrix.arch }})
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          path: 'build'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.arch == 'arm64' && 'aarch64-unknown-linux-gnu' || '' }}

      - name: Build Component
        uses: ./build/.github/actions/build-cosmic
        with:
          app_name: ${{ matrix.name }}
          repository: ${{ matrix.repo }}
          ref: ${{ matrix.ref }}
          cargo_patch: ${{ matrix.patch }}
          arch: ${{ matrix.arch }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          # 全ての成果物を一つの名前空間（packages）に集約しやすくする
          name: all-packages-${{ matrix.id }}-${{ matrix.arch }}
          path: dist/*.deb

  publish-repo:
    needs: build-all
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo-site
        continue-on-error: true # 初回実行時などでブランチがない場合を考慮

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-packages
          pattern: all-packages-*
          merge-multiple: true

      - name: Structure Apt Repository
        run: |
          mkdir -p repo-site/conf
          # パッケージファイルを構造化ディレクトリに移動
          mkdir -p repo-site/pool/main
          cp downloaded-packages/*.deb repo-site/pool/main/

          # apt-ftparchive を使用してインデックス作成
          cd repo-site
          
          # 1. Packages ファイル生成
          apt-ftparchive packages pool/main > Packages
          gzip -c Packages > Packages.gz
          
          # 2. Release ファイル生成
          apt-ftparchive release . > Release
          
          # (オプション) GPG署名を行う場合はここに gpg --clearsign 等を追加
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo-site
          publish_branch: gh-pages

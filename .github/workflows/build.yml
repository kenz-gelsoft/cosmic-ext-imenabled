name: Build
on: [push]

env:
  CARGO_TERM_COLOR: always
  # 1. Cargoのホームをワークスペース内に設定
  CARGO_HOME: ${{ github.workspace }}/.cargo

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cosmic-files
    steps:
      - name: Check out patches
        uses: actions/checkout@v6
      - name: Check out app code
        uses: actions/checkout@v6
        with:
          repository: pop-os/cosmic-files
          ref: epoch-1.0.0
          path: cosmic-files

      - name: Install build dependencies
        run: |
          sudo apt-get update
          # devscripts は debuild を含むパッケージ
          # equivs は Build-Depends から依存関係を自動インストールするために使用
          sudo apt-get install -y devscripts debhelper equivs

      - name: Install package build dependencies
        run: |
          # debian/control を解析して必要なライブラリを自動インストール
          sudo mk-build-deps -i -t "apt-get -o Debug::pkgProblemResolver=yes -y" debian/control

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # Rustのキャッシュを有効化（ビルド時間を大幅短縮）
      # 2. カスタムパスのCargoキャッシュを有効化
      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "cosmic-files -> target"
          # CARGO_HOME の場所を明示
          cache-directories: |
            ${{ env.CARGO_HOME }}

      - name: Patch Cargo.toml to use the libcosmic fork with IME support backported
        run: |
          cat <<EOF >> Cargo.toml
          
          [patch.'https://github.com/pop-os/libcosmic']
          libcosmic = { git = "https://github.com/kenz-gelsoft/libcosmic.git", branch = "backport-input-method2" }
          EOF
          cargo update libcosmic

      - name: Patch debian/rules to allow using the rust toolchain installed by rustup
        run: sed '\|export DESTDIR|a export PATH := $(HOME)/.cargo/bin:$(PATH)' debian/rules -i
      
      - name: Build package using debuild
        run: |
          # 3. -e オプションで CARGO_HOME を引き継ぐ
          # -us: ソースに署名しない
          # -uc: .changes ファイルに署名しない
          # -b: バイナリパッケージのみビルド (ソースを含める場合は不要)
          # プロセッサ数に合わせて並列ビルドを指定 (-j)
          debuild -e CARGO_HOME=$CARGO_HOME \
            -us -uc -b -j$(nproc)

      - name: Move artifacts
        run: |
          # debuild は上の階層 (..) に成果物を出力するため、整理する
          mkdir -p ../dist
          mv ../*.deb ../dist/
          mv ../*.changes ../dist/ || true
          mv ../*.buildinfo ../dist/ || true

      - name: Upload deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

      - name: Upload changes Artifact
        uses: actions/upload-artifact@v4
        with:
          name: changes
          path: dist/*.changes

      - name: Upload buildinfo Artifact
        uses: actions/upload-artifact@v4
        with:
          name: buildinfo
          path: dist/*.buildinfo

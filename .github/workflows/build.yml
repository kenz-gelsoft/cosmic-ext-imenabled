# .github/workflows/build.yml
name: Build and Publish Apt Repo
on:
  push:
    paths:
      - "*/debian/*"
      - "*/Cargo.lock"
      - ".github/actions/build-cosmic/action.yml"
      - ".github/workflows/build.yml"

env:
  CARGO_TERM_COLOR: always

jobs:
  build-all:
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    container:
      image: debian:bookworm
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        id:
          - files
          - applibrary
          - launcher
          - edit
          - term
        include:
          - id: files
            name: cosmic-files
            repo: pop-os/cosmic-files
            ref: epoch-1.0.5
            patch: |
              cat <<EOF >> Cargo.toml
              [patch.'https://github.com/pop-os/libcosmic']
              libcosmic = { git = "https://github.com/kenz-gelsoft/libcosmic.git", branch = "backport-input-method" }
              EOF
          - id: applibrary
            name: cosmic-app-library
            repo: pop-os/cosmic-applibrary
            ref: epoch-1.0.5
            patch: |
              cat <<EOF >> Cargo.toml
              [patch.'https://github.com/pop-os/libcosmic']
              libcosmic = { git = "https://github.com/kenz-gelsoft/libcosmic.git", branch = "backport-input-method" }
              EOF
          - id: launcher
            name: cosmic-launcher
            repo: pop-os/cosmic-launcher
            ref: epoch-1.0.5
            patch: |
              cat <<EOF >> Cargo.toml
              [patch.'https://github.com/pop-os/libcosmic']
              libcosmic = { git = "https://github.com/kenz-gelsoft/libcosmic.git", branch = "backport-input-method" }
              EOF
          - id: edit
            name: cosmic-edit
            repo: kenz-gelsoft/cosmic-edit
            ref: backport-input-method
            patch: ""
          - id: term
            name: cosmic-term
            repo: kenz-gelsoft/cosmic-term
            ref: backport-input-method
            patch: ""

    name: Build ${{ matrix.name }} (${{ matrix.arch }})
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          path: "build"

      - name: Install prerequisites
        shell: bash
        run: |
          #sudo
          apt-get update
          #sudo
          apt-get install -y curl

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.arch == 'arm64' && 'aarch64-unknown-linux-gnu' || '' }}

      - name: Build Component
        uses: ./build/.github/actions/build-cosmic
        with:
          app_name: ${{ matrix.name }}
          repository: ${{ matrix.repo }}
          ref: ${{ matrix.ref }}
          cargo_patch: ${{ matrix.patch }}
          arch: ${{ matrix.arch }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          # 全ての成果物を一つの名前空間（packages）に集約しやすくする
          name: all-packages-${{ matrix.id }}-${{ matrix.arch }}
          path: |
            dist/*.deb
            dist/*.rpm

  publish-repo:
    needs: build-all
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo-site
        continue-on-error: true # 初回実行時などでブランチがない場合を考慮

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-packages
          pattern: all-packages-*
          merge-multiple: true

      - name: Structure Apt/Yum Repository
        run: |
          sudo apt-get update && sudo apt-get install -y reprepro createrepo-c

          mkdir -p repo-site/conf

          # Remove old RPMs as they are not deleted automatically.
          rm repo-site/*.rpm

          # create Yum repo
          cp downloaded-packages/*.rpm repo-site/
          createrepo_c repo-site

          # 1. reprepro の設定ファイルを作成
          cat <<EOF > repo-site/conf/distributions
          Origin: MyCosmicRepo
          Label: MyCosmicRepo
          Codename: stable
          Architectures: amd64 arm64
          Components: main
          Description: Backported Cosmic Components
          EOF

          # 2. パッケージをリポジトリに追加
          # --basedir で repo-site を指定し、全 .deb を一括インポート
          cd repo-site
          for deb in ../downloaded-packages/*.deb; do
            reprepro includedeb stable "$deb"
          done

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo-site
          publish_branch: gh-pages

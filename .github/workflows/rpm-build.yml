name: Build RPM (AlmaLinux 10)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: almalinux:10
      options: --user root

    steps:
      - name: Install Git
        run: dnf install -y git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install System Dependencies
        run: |
          # EPEL 10 の導入
          dnf install -y epel-release
          # EL10では CRB の有効化方法が標準化されています
          dnf config-manager --set-enabled crb || dnf install -y 'dnf-command(config-manager)' && dnf config-manager --set-enabled crb
          # just を含む全依存関係を RPM でインストール
          dnf install -y \
            rpm-build \
            pkgconfig \
            gcc-c++ \
            cargo \
            rust \
            just \
            glib2-devel \
            libxkbcommon-devel \
            cmake \
            freetype-devel \
            fontconfig-devel \
            wayland-devel \
            libinput-devel \
            libxkbcommon-x11-devel

      - name: Prepare Sources
        run: |
          mkdir -p ~/rpmbuild/SOURCES
          
          # 1. cargo vendor を直接実行して vendor ディレクトリを強制作成
          # これにより全依存関係が ./vendor にダウンロードされます
          cargo vendor
          
          # 2. just build-vendored が期待する形式に固める
          # vendor ディレクトリが存在することを確認してから実行
          if [ -d "vendor" ]; then
            tar -cf vendor.tar vendor/
          else
            echo "Error: vendor directory was not created!"
            exit 1
          fi
          
          # 3. RPMビルド用のディレクトリ構造を作成して固める
          mkdir -p ../cosmic-edit-ime-0.1.0
          cp -r . ../cosmic-edit-ime-0.1.0/
          cd ..
          tar -czf ~/rpmbuild/SOURCES/cosmic-edit-ime-0.1.0.tar.gz cosmic-edit-ime-0.1.0/

      - name: Execute rpmbuild
        run: |
          rpmbuild -ba cosmic-edit/rpm/cosmic-edit.spec --define "_topdir $HOME/rpmbuild"

      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: cosmic-edit-el10-rpm
          path: ~/rpmbuild/RPMS/*/*.rpm
